<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CD Tir 66 — Mission Arbitre (Remboursement)</title>

  <!-- Libs PDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --txt:#0f1222;
      --muted:#55607a;
      --line:#e8ecf3;

      /* Arbitres */
      --brand:#1aa66a;
      --brand2:#2fcf8f;
      --soft:#eafaf2;

      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}

    .hero{
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;border-radius:22px;padding:18px;
      box-shadow:0 12px 30px rgba(17,24,39,.10);
      display:flex;gap:16px;align-items:center;
    }
    .hero__logo{
      width:86px;height:86px;border-radius:16px;
      background:rgba(255,255,255,.22);
      padding:10px;object-fit:contain;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    .hero h1{margin:0;font-size:clamp(22px,3vw,34px);line-height:1.15}
    .hero p{margin:6px 0 0;opacity:.92}
    .pill{
      display:inline-block;margin-top:10px;
      background:rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.45);
      padding:6px 12px;border-radius:999px;font-weight:800;font-size:12px
    }

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:var(--radius);padding:16px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);
    }
    .card h2{margin:0 0 12px;font-size:20px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}

    label{display:block;font-weight:700;font-size:13px;color:#334; margin:10px 0 6px}
    input, select, textarea{
      width:100%;
      border:1px solid #e2e7f0;
      border-radius:14px;
      padding:12px 12px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(26,166,106,.55);
      box-shadow:0 0 0 4px rgba(26,166,106,.12);
    }
    textarea{min-height:110px;resize:vertical}

    .totals{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .kpi{
      border:1px dashed #cfe6da;
      background:var(--soft);
      border-radius:14px;padding:12px;
    }
    .kpi b{display:block;font-size:13px;color:#245}
    .kpi span{display:block;margin-top:6px;font-size:22px;font-weight:900}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:0;border-radius:999px;
      padding:12px 16px;
      font-weight:900;font-size:15px;
      cursor:pointer;
    }
    .btn-primary{background:#0d6efd;color:#fff}
    .btn-light{background:#eef2ff;color:#111}
    .btn-dark{background:#111827;color:#fff}
    .hint{margin-top:10px;color:#556; font-size:13px}
    .warn{margin-top:10px;font-size:13px;color:#385; display:flex;gap:8px;align-items:flex-start}
    .warn b{color:#184}

    /* Zone à exporter */
    #pdfArea{
      padding:14px;
      background:#fff;
      border-radius:18px;
      border:1px solid var(--line);
    }
  </style>
</head>

<body>
  <div class="wrap">

    <header class="hero">
      <img class="hero__logo" src="logo-cdtir66.png" alt="Logo CD Tir 66">
      <div>
        <h1>Demande de remboursement — Mission Arbitre</h1>
        <p>PDF A4 téléchargeable : KM, péages, hôtel, restaurant (sans indemnités journalières).</p>
        <div class="pill">Comité Départemental de Tir — Pyrénées-Orientales (66)</div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div id="pdfArea">
          <h2>1) Identité</h2>
          <div class="row">
            <div>
              <label>Nom *</label>
              <input id="nom" required>
            </div>
            <div>
              <label>Prénom *</label>
              <input id="prenom" required>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Club *</label>
              <input id="club" required>
            </div>
            <div>
              <label>N° licence</label>
              <input id="licence">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Email *</label>
              <input id="email" type="email" required>
            </div>
            <div>
              <label>Téléphone</label>
              <input id="tel">
            </div>
          </div>

          <hr style="border:0;border-top:1px solid var(--line);margin:16px 0">

          <h2>2) Mission</h2>
          <label>Intitulé mission / compétition *</label>
          <input id="intitule" placeholder="Ex : Championnat départemental 10 m" required>

          <div class="row">
            <div>
              <label>Lieu *</label>
              <input id="lieu" placeholder="Ville / Stand" required>
            </div>
            <div>
              <label>Aller / retour</label>
              <select id="ar">
                <option value="Oui">Oui</option>
                <option value="Non">Non</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Date début *</label>
              <input id="d1" type="date" required>
            </div>
            <div>
              <label>Date fin *</label>
              <input id="d2" type="date" required>
            </div>
          </div>

          <label>Commentaires (optionnel)</label>
          <textarea id="com" placeholder="Infos utiles (horaires, covoiturage, etc.)"></textarea>

          <div class="hint">Astuce : tu peux générer le PDF puis l’imprimer en PDF si besoin.</div>
        </div>
      </section>

      <section class="card">
        <h2>3) Frais à rembourser</h2>
        <div class="row">
          <div>
            <label>Distance totale (km) *</label>
            <input id="km" type="number" min="0" step="1" placeholder="Ex : 180">
          </div>
          <div>
            <label>Taux kilométrique (€/km)</label>
            <input id="taux" type="number" min="0" step="0.001" placeholder="Ex : 0.321">
            <div class="hint">Si renseigné, le total KM est calculé automatiquement.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Autoroute / péages (€)</label>
            <input id="peage" type="number" min="0" step="0.01" value="0">
          </div>
          <div>
            <label>Hôtel (€)</label>
            <input id="hotel" type="number" min="0" step="0.01" value="0">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Restaurant (€)</label>
            <input id="resto" type="number" min="0" step="0.01" value="0">
          </div>
          <div>
            <label>Autres (optionnel) (€)</label>
            <input id="autres" type="number" min="0" step="0.01" value="0">
          </div>
        </div>

        <div class="totals">
          <div class="kpi">
            <b>Total KM (km × taux)</b>
            <span id="totalKm">—</span>
          </div>
          <div class="kpi">
            <b>Total général</b>
            <span id="totalGen">0,00 €</span>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" id="btnPdf">Télécharger le PDF</button>
          <button class="btn-light" id="btnPrint">Imprimer</button>
          <button class="btn-dark" id="btnReset" type="button">Réinitialiser</button>
        </div>

        <div class="warn">⚠️ <div><b>Justificatifs :</b> les photos/PDF ne sont pas intégrés automatiquement dans le PDF.</div></div>
      </section>
    </div>

  </div>

  <script>
    // Helpers
    const $ = (id) => document.getElementById(id);
    const n = (v) => {
      const x = Number(String(v).replace(",", "."));
      return Number.isFinite(x) ? x : 0;
    };
    const eur = (x) => x.toLocaleString("fr-FR", {minimumFractionDigits:2, maximumFractionDigits:2}) + " €";

    function calc(){
      const km = n($("km").value);
      const taux = n($("taux").value);
      const peage = n($("peage").value);
      const hotel = n($("hotel").value);
      const resto = n($("resto").value);
      const autres = n($("autres").value);

      const totalKm = (km > 0 && taux > 0) ? km * taux : 0;
      $("totalKm").textContent = (km > 0 && taux > 0) ? eur(totalKm) : "—";

      const totalGen = totalKm + peage + hotel + resto + autres;
      $("totalGen").textContent = eur(totalGen);
    }

    ["km","taux","peage","hotel","resto","autres"].forEach(id=>{
      $(id).addEventListener("input", calc);
    });
    calc();

    $("btnPrint").addEventListener("click", () => window.print());
    $("btnReset").addEventListener("click", () => location.reload());

    async function generatePdf(){
  try{
    if(!window.html2canvas) throw new Error("html2canvas non chargé");
    if(!window.jspdf || !window.jspdf.jsPDF) throw new Error("jsPDF UMD non chargé");

    const area = document.getElementById("pdfArea");
    if(!area) throw new Error("#pdfArea introuvable");

    // Capture nette
    const canvas = await html2canvas(area, {
      scale: 2,
      useCORS: true,
      allowTaint: false,
      backgroundColor: "#ffffff",
      scrollX: 0,
      scrollY: -window.scrollY
    });

    const imgData = canvas.toDataURL("image/jpeg", 0.92); // JPG souvent plus léger/clean
    const { jsPDF } = window.jspdf;

    const pdf = new jsPDF("p", "mm", "a4");

    const pageW = pdf.internal.pageSize.getWidth();   // ~210
    const pageH = pdf.internal.pageSize.getHeight();  // ~297
    const margin = 10;

    const usableW = pageW - margin*2;
    const usableH = pageH - margin*2;

    // Dimensions image dans le PDF (on fit en largeur)
    const imgW = usableW;
    const imgH = (canvas.height * imgW) / canvas.width;

    // Si ça tient sur une page → simple
    if(imgH <= usableH){
      pdf.addImage(imgData, "JPEG", margin, margin, imgW, imgH);
    } else {
      // Multi-pages : on découpe proprement le canvas en tranches
      const pxPerMm = canvas.width / imgW;              // pixels par mm (selon fit largeur)
      const pagePxH = Math.floor(usableH * pxPerMm);    // hauteur en pixels par page

      let y = 0;
      let pageIndex = 0;

      while (y < canvas.height){
        const sliceH = Math.min(pagePxH, canvas.height - y);

        const pageCanvas = document.createElement("canvas");
        pageCanvas.width = canvas.width;
        pageCanvas.height = sliceH;

        const ctx = pageCanvas.getContext("2d");
        ctx.drawImage(canvas, 0, y, canvas.width, sliceH, 0, 0, canvas.width, sliceH);

        const sliceData = pageCanvas.toDataURL("image/jpeg", 0.92);
        const sliceH_mm = sliceH / pxPerMm;

        if(pageIndex > 0) pdf.addPage();
        pdf.addImage(sliceData, "JPEG", margin, margin, imgW, sliceH_mm);

        y += sliceH;
        pageIndex++;
      }
    }

    // Nom de fichier propre
    const safe = (s) => String(s||"").trim().replace(/[^\p{L}\p{N}\- ]/gu,"").replace(/\s+/g,"_");
    const nom = safe(document.getElementById("nom")?.value);
    const prenom = safe(document.getElementById("prenom")?.value);
    pdf.save(`Remboursement_Arbitre_${nom}_${prenom}.pdf`);

  }catch(err){
    console.error(err);
    alert("Erreur PDF : " + (err?.message || err));
  }
}

      const area = $("pdfArea");

      // Render to canvas
      const canvas = await html2canvas(area, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff"
      });

      const imgData = canvas.toDataURL("image/png");
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      // Fit image into A4
      const imgW = pageW;
      const imgH = (canvas.height * imgW) / canvas.width;

      let y = 10;
      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(14);
      pdf.text("Demande de remboursement — Mission Arbitre", 10, y);
      y += 6;
      pdf.setFont("helvetica", "normal");
      pdf.setFontSize(10);
      pdf.text("Comité Départemental de Tir — Pyrénées-Orientales (66)", 10, y);

      // Put form capture below header
      const topMargin = 22;
      const availableH = pageH - topMargin - 10;

      if(imgH <= availableH){
        pdf.addImage(imgData, "PNG", 10, topMargin, pageW-20, imgH * ((pageW-20)/imgW));
      } else {
        // Multi-page if needed
        let imgY = 0;
        const ratio = (pageW-20) / canvas.width;
        const pageCanvasH = (availableH / ratio);

        while(imgY < canvas.height){
          const pageCanvas = document.createElement("canvas");
          pageCanvas.width = canvas.width;
          pageCanvas.height = Math.min(pageCanvasH, canvas.height - imgY);

          const ctx = pageCanvas.getContext("2d");
          ctx.drawImage(canvas, 0, imgY, canvas.width, pageCanvas.height, 0, 0, canvas.width, pageCanvas.height);

          const pageImg = pageCanvas.toDataURL("image/png");
          pdf.addImage(pageImg, "PNG", 10, topMargin, pageW-20, pageCanvas.height * ratio);

          imgY += pageCanvas.height;
          if(imgY < canvas.height) pdf.addPage();
        }
      }

      // Filename
      const safe = (s) => String(s||"").trim().replace(/[^\p{L}\p{N}\- ]/gu,"").replace(/\s+/g,"_");
      const filename = `Remboursement_Arbitre_${safe($("nom").value)}_${safe($("prenom").value)}.pdf`;
      pdf.save(filename);
    }

    $("btnPdf").addEventListener("click", generatePdf);
  </script>
</body>
</html>
