<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CD Tir 66 — Mission Arbitre (Remboursement)</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --txt:#0f1222;
      --muted:#55607a;
      --line:#e8ecf3;

      /* Arbitres */
      --brand:#1aa66a;
      --brand2:#2fcf8f;
      --soft:#eafaf2;

      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}

    /* Bandeau écran */
    .hero{
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;border-radius:22px;padding:18px;
      box-shadow:0 12px 30px rgba(17,24,39,.10);
      display:flex;gap:16px;align-items:center;
    }
    .hero__logo{
      width:86px;height:86px;border-radius:16px;
      background:rgba(255,255,255,.22);
      padding:10px;object-fit:contain;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    .hero h1{margin:0;font-size:clamp(22px,3vw,34px);line-height:1.15}
    .hero p{margin:6px 0 0;opacity:.92}
    .pill{
      display:inline-block;margin-top:10px;
      background:rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.45);
      padding:6px 12px;border-radius:999px;
      font-weight:800;font-size:12px
    }

    /* Zone capturée PDF : 1 colonne (A4 friendly) */
    #pdfArea{
      margin-top:14px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:22px;
      padding:16px;
      box-shadow:0 8px 22px rgba(0,0,0,.06);

      max-width:760px;     /* largeur confortable A4 */
      margin-left:auto;
      margin-right:auto;
    }

    /* Entête PDF coloré (visible seulement en PDF) */
    .pdfHeader{
      display:none;
      align-items:center;
      gap:12px;
      padding:12px 12px;
      border-radius:16px;
      background:linear-gradient(135deg, rgba(26,166,106,.92), rgba(47,207,143,.92));
      color:#fff;
    }
    .pdfHeader img{
      width:46px;height:46px;object-fit:contain;
      background:rgba(255,255,255,.2);
      border-radius:12px;
      padding:6px;
    }
    .pdfHeader__title{font-size:15px;font-weight:950;line-height:1.2}
    .pdfHeader__sub{font-size:12px;font-weight:750;opacity:.95;margin-top:2px}
    .pdfRule{display:none;height:1px;background:#e8ecf3;margin:12px 0 14px}

    /* Sections */
    .section{
      border:1px solid #e6ebf4;
      border-radius:18px;
      padding:14px;
      margin-top:12px;
      background:#fff;
    }
    .section h2{
      margin:0 0 12px;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badgeNum{
      width:28px;height:28px;border-radius:10px;
      display:inline-flex;align-items:center;justify-content:center;
      font-weight:950;
      background:var(--soft);
      border:1px solid #cfe6da;
      color:#145;
      flex:0 0 auto;
      font-size:13px;
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.row{grid-template-columns:1fr}}

    label{
      display:block;
      font-weight:850;
      font-size:13px;
      color:#334;
      margin:10px 0 6px
    }
    .req{color:#d11;font-weight:950}

    input, select, textarea{
      width:100%;
      border:1px solid #e2e7f0;
      border-radius:12px;
      padding:11px 12px;
      font-size:15px;
      outline:none;
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(26,166,106,.55);
      box-shadow:0 0 0 4px rgba(26,166,106,.12);
    }
    textarea{min-height:92px;resize:vertical}

    .hint{margin-top:8px;color:#556;font-size:13px;line-height:1.35}

    /* Totaux (couleur légère) */
    .totals{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    .kpi{
      border:1px solid rgba(26,166,106,.25);
      background:linear-gradient(180deg, rgba(234,250,242,1), rgba(255,255,255,1));
      border-radius:14px;
      padding:10px 12px;
    }
    .kpi b{display:block;font-size:12px;color:#245}
    .kpi span{display:block;margin-top:6px;font-size:20px;font-weight:950}

    /* Case attestation (reste utile, mais ne change pas le PDF) */
    .checkline{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top:12px;
      padding:10px 12px;
      border:1px dashed #cfe6da;
      border-radius:12px;
      background:#fbfffd;
    }
    .checkline input{width:18px;height:18px;margin-top:2px}
    .checkline b{display:block}
    .checkline small{display:block;color:var(--muted);margin-top:3px;line-height:1.25}

    /* Signature trésorier (PDF only) */
    .pdfTreasurer{
      display:none;
      margin-top:14px;
      padding-top:10px;
      border-top:1px solid #e8ecf3;
      color:#223;
      font-size:12px;
      line-height:1.35;
    }
    .pdfFooter__line{
      display:flex;
      justify-content:space-between;
      gap:12px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .pdfFooter__sig{
      min-width:240px;
      border:1px solid #e6ebf4;
      border-radius:12px;
      padding:10px 12px;
      color:#445;
      background:#fff;
    }

    /* Mode PDF */
    #pdfArea.pdf-mode .pdfHeader,
    #pdfArea.pdf-mode .pdfTreasurer{
      display:flex;
    }
    #pdfArea.pdf-mode .pdfHeader{display:flex}
    #pdfArea.pdf-mode .pdfTreasurer{display:block}

    /* Boutons hors PDF */
    .actions{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;
      max-width:760px;margin-left:auto;margin-right:auto;
    }
    button{
      border:0;border-radius:999px;
      padding:12px 16px;
      font-weight:950;font-size:15px;
      cursor:pointer;
    }
    .btn-primary{background:#0d6efd;color:#fff}
    .btn-light{background:#eef2ff;color:#111}
    .btn-dark{background:#111827;color:#fff}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="hero">
      <img class="hero__logo" src="logo-cdtir66.png" alt="Logo CD Tir 66" crossorigin="anonymous">
      <div>
        <h1>Demande de remboursement — Mission Arbitre</h1>
        <p>PDF A4 (portrait) téléchargeable : KM, péages, hôtel, restaurant (sans indemnités journalières).</p>
        <div class="pill">Comité Départemental de Tir — Pyrénées-Orientales (66)</div>
      </div>
    </header>

    <!-- Zone capturée PDF -->
    <div id="pdfArea">
      <!-- Entête PDF coloré -->
      <div class="pdfHeader">
        <img src="logo-cdtir66.png" alt="Logo CD Tir 66" crossorigin="anonymous">
        <div>
          <div class="pdfHeader__title">Demande de remboursement — Mission Arbitre</div>
          <div class="pdfHeader__sub">Comité Départemental de Tir — Pyrénées-Orientales (66)</div>
        </div>
      </div>
      <div class="pdfRule"></div>

      <!-- 1) Identité -->
      <section class="section">
        <h2><span class="badgeNum">1</span> Identité</h2>

        <div class="row">
          <div>
            <label>Nom <span class="req">*</span></label>
            <input id="nom" required>
          </div>
          <div>
            <label>Prénom <span class="req">*</span></label>
            <input id="prenom" required>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Club <span class="req">*</span></label>
            <input id="club" required>
          </div>
          <div>
            <label>N° licence</label>
            <input id="licence">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Email <span class="req">*</span></label>
            <input id="email" type="email" required>
          </div>
          <div>
            <label>Téléphone</label>
            <input id="tel">
          </div>
        </div>
      </section>

      <!-- 2) Mission -->
      <section class="section">
        <h2><span class="badgeNum">2</span> Mission</h2>

        <label>Intitulé mission / compétition <span class="req">*</span></label>
        <input id="intitule" placeholder="Ex : Championnat départemental 10 m" required>

        <div class="row">
          <div>
            <label>Lieu <span class="req">*</span></label>
            <input id="lieu" placeholder="Ville / Stand" required>
          </div>
          <div>
            <label>Aller / retour</label>
            <select id="ar">
              <option value="Oui">Oui</option>
              <option value="Non">Non</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Date début <span class="req">*</span></label>
            <input id="d1" type="date" required>
          </div>
          <div>
            <label>Date fin <span class="req">*</span></label>
            <input id="d2" type="date" required>
          </div>
        </div>

        <label>Commentaires (optionnel)</label>
        <textarea id="com" placeholder="Infos utiles (horaires, covoiturage, etc.)"></textarea>

        <div class="hint">Astuce : tu peux générer le PDF puis l’imprimer en PDF si besoin.</div>
      </section>

      <!-- 3) Frais -->
      <section class="section">
        <h2><span class="badgeNum">3</span> Frais à rembourser</h2>

        <div class="row">
          <div>
            <label>Distance totale (km)</label>
            <input id="km" type="number" min="0" step="1" placeholder="Ex : 180">
          </div>
          <div>
            <label>Taux kilométrique (€/km)</label>
            <input id="taux" type="number" min="0" step="0.001" placeholder="Ex : 0.321">
            <div class="hint">Si renseigné, le total KM est calculé automatiquement.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Autoroute / péages (€)</label>
            <input id="peage" type="number" min="0" step="0.01" value="0">
          </div>
          <div>
            <label>Hôtel (€)</label>
            <input id="hotel" type="number" min="0" step="0.01" value="0">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Restaurant (€)</label>
            <input id="resto" type="number" min="0" step="0.01" value="0">
          </div>
          <div>
            <label>Autres (optionnel) (€)</label>
            <input id="autres" type="number" min="0" step="0.01" value="0">
          </div>
        </div>

        <div class="totals">
          <div class="kpi">
            <b>Total KM (km × taux)</b>
            <span id="totalKm">—</span>
          </div>
          <div class="kpi">
            <b>Total général</b>
            <span id="totalGen">0,00 €</span>
          </div>
        </div>

        <div class="checkline">
          <input id="atteste" type="checkbox">
          <div>
            <b>J’atteste sur l’honneur l’exactitude de mes déclarations.</b>
            <small>Information conservée dans le formulaire (pas de footer d’attestation dans le PDF).</small>
          </div>
        </div>

        <div class="hint">⚠️ Les justificatifs (photos/PDF) ne sont pas intégrés automatiquement dans le PDF.</div>
      </section>

      <!-- Signature trésorier (PDF only) -->
      <div id="pdfTreasurer" class="pdfTreasurer">
        <b>Signature du trésorier</b>
        <div class="pdfFooter__line">
          <div class="pdfFooter__sig">Nom : ____________________<br>Date : ____ / ____ / ______</div>
          <div class="pdfFooter__sig">Signature :</div>
        </div>
      </div>
    </div>

    <!-- Actions hors PDF -->
    <div class="actions" id="actionsBar">
      <button class="btn-primary" id="btnPdf">Télécharger le PDF</button>
      <button class="btn-light" id="btnPrint">Imprimer</button>
      <button class="btn-dark" id="btnReset" type="button">Réinitialiser</button>
    </div>
  </div>

  <!-- Libs PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);
    const n = (v) => {
      const x = Number(String(v ?? "").replace(",", "."));
      return Number.isFinite(x) ? x : 0;
    };
    const eur = (x) =>
      x.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";

    function calc(){
      const km = n($("km").value);
      const taux = n($("taux").value);
      const peage = n($("peage").value);
      const hotel = n($("hotel").value);
      const resto = n($("resto").value);
      const autres = n($("autres").value);

      const totalKm = (km > 0 && taux > 0) ? km * taux : 0;
      $("totalKm").textContent = (km > 0 && taux > 0) ? eur(totalKm) : "—";

      const totalGen = totalKm + peage + hotel + resto + autres;
      $("totalGen").textContent = eur(totalGen);
    }
    ["km","taux","peage","hotel","resto","autres"].forEach(id => {
      $(id).addEventListener("input", calc);
    });
    calc();

    $("btnPrint").addEventListener("click", () => window.print());
    $("btnReset").addEventListener("click", () => location.reload());

    async function generatePdf(){
      try{
        if(!window.html2canvas) throw new Error("html2canvas non chargé");
        if(!window.jspdf || !window.jspdf.jsPDF) throw new Error("jsPDF UMD non chargé");

        const required = ["nom","prenom","club","email","intitule","lieu","d1","d2"];
        for(const id of required){
          const el = $(id);
          if(!el.value){
            el.focus();
            alert("Merci de compléter les champs obligatoires (*) avant de générer le PDF.");
            return;
          }
        }

        const area = $("pdfArea");

        // Mode PDF (affiche l’entête et la signature)
        area.classList.add("pdf-mode");

        // Masque les boutons
        const actions = $("actionsBar");
        const prevDisplay = actions.style.display;
        actions.style.display = "none";

        // Capture
        const canvas = await html2canvas(area, {
          scale: 2,
          useCORS: true,
          allowTaint: false,
          backgroundColor: "#ffffff",
          scrollX: 0,
          scrollY: -window.scrollY
        });

        // Restore UI
        actions.style.display = prevDisplay || "flex";
        area.classList.remove("pdf-mode");

        const imgData = canvas.toDataURL("image/jpeg", 0.92);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");

        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const margin = 8;

        const maxW = pageW - margin*2;
        const maxH = pageH - margin*2;

        let imgW = maxW;
        let imgH = (canvas.height * imgW) / canvas.width;

        // 1 page max : on ajuste pour tenir
        if(imgH > maxH){
          imgH = maxH;
          imgW = (canvas.width * imgH) / canvas.height;
        }

        const x = (pageW - imgW) / 2;
        const y = (pageH - imgH) / 2;

        pdf.addImage(imgData, "JPEG", x, y, imgW, imgH);

        const safe = (s) => String(s||"")
          .trim()
          .replace(/[^\p{L}\p{N}\- ]/gu,"")
          .replace(/\s+/g,"_");

        const nom = safe($("nom").value);
        const prenom = safe($("prenom").value);
        pdf.save(`Remboursement_Arbitre_${nom}_${prenom}.pdf`);

      }catch(err){
        console.error(err);
        alert("Erreur PDF : " + (err?.message || err));
        // restore safe
        $("pdfArea")?.classList.remove("pdf-mode");
        $("actionsBar") && ($("actionsBar").style.display = "flex");
      }
    }

    $("btnPdf").addEventListener("click", generatePdf);
  </script>
</body>
</html>
